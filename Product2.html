<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Todo el head se mantiene igual hasta el cierre de </style> -->
    <!-- Añade estos estilos adicionales antes del cierre de </style> -->
    
    /* Estilos adicionales para el carrito */
    .cart-icon {
        position: relative;
        display: inline-block;
        margin-left: 20px;
    }
    
    .cart-counter {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--neon-pink);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }
    
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: #333;
        color: white;
        border-radius: 4px;
        z-index: 1000;
        animation: fadeIn 0.3s;
    }
    
    .toast-success {
        background: var(--neon-purple);
    }
    
    .toast-error {
        background: #F44336;
    }
    
    .cart-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        width: 300px;
        background: rgba(0,0,0,0.95);
        border: 1px solid var(--neon-purple);
        border-radius: 5px;
        padding: 15px;
        z-index: 1000;
        box-shadow: var(--glow-effect);
    }
    
    .cart-item {
        display: flex;
        margin-bottom: 10px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
    }
    
    .cart-item img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 10px;
        border-radius: 3px;
    }
    
    .cart-item-info {
        flex: 1;
    }
    
    .cart-total {
        font-weight: bold;
        margin-top: 10px;
        text-align: right;
    }
    
    .checkout-btn {
        width: 100%;
        margin-top: 10px;
    }
</head>
<body>
    <!-- Modifica el header para añadir el icono del carrito -->
    <header>
        <img src="logo-imatge1.PNG" alt="FREE4ALLRIDERS" class="logo">
        <nav>
            <a href="index.html">Inicio</a>
            <a href="index.html#products">Colección</a>
            <a href="Contact.html">Contacto</a>
            <a href="login.html" id="authLink">Login</a>
            <div class="cart-icon" id="cartIcon">
                🛒 <span class="cart-counter" id="cartCounter" style="display: none;">0</span>
                <div class="cart-dropdown" id="cartDropdown">
                    <div id="cartItems"></div>
                    <div class="cart-total">Total: $<span id="cartTotal">0</span></div>
                    <button class="btn btn-primary checkout-btn" id="checkoutBtn">Finalizar Compra</button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Todo el contenido principal se mantiene igual -->

    <!-- Añade este modal adicional para el checkout -->
    <div id="checkoutModal" class="order-confirmation">
        <div class="confirmation-content">
            <h2 class="confirmation-title">Resumen de Compra</h2>
            <div id="checkoutSummary"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="confirmCheckout">Confirmar Compra</button>
                <button class="btn btn-secondary" onclick="document.getElementById('checkoutModal').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Al final del body, antes del cierre </body>, reemplaza todo el script con este: -->
    <script>
        // Configuración Firebase (usa tus datos reales)
        const firebaseConfig = {
    apiKey: "AIzaSyAnhkZ3lkRpS8bBHI8OKYlYmpyRisahrdQ",
    authDomain: "free4allriders-51c5e.firebaseapp.com",
    projectId: "free4allriders-51c5e",
    storageBucket: "free4allriders-51c5e.firebasestorage.app",
    messagingSenderId: "1082764494980",
    appId: "1:1082764494980:web:a124d3dfeed2c08d8b5ad1",
    measurementId: "G-7KEGQPK3P0"
  };



        // Inicialización Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase inicializado correctamente");
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const CART_STORAGE_KEY = 'free4all_cart';

        // Objeto del carrito
        let cart = {
            items: [],
            total: 0,
            
            init: function() {
                this.load();
                this.updateUI();
            },
            
            load: function() {
                const savedCart = localStorage.getItem(CART_STORAGE_KEY);
                if (savedCart) {
                    const parsedCart = JSON.parse(savedCart);
                    this.items = parsedCart.items || [];
                    this.total = parsedCart.total || 0;
                }
            },
            
            save: function() {
                localStorage.setItem(
                    CART_STORAGE_KEY, 
                    JSON.stringify({
                        items: this.items,
                        total: this.total
                    })
                );
                this.updateUI();
            },
            
            addItem: function(product) {
                const existingItem = this.items.find(item => 
                    item.id === product.id && item.size === product.size);
                
                if (existingItem) {
                    existingItem.quantity += product.quantity;
                } else {
                    this.items.push(product);
                }
                
                this.calculateTotal();
                this.save();
            },
            
            removeItem: function(index) {
                this.items.splice(index, 1);
                this.calculateTotal();
                this.save();
            },
            
            calculateTotal: function() {
                this.total = this.items.reduce((sum, item) => {
                    return sum + (item.price * item.quantity);
                }, 0);
            },
            
            clear: function() {
                this.items = [];
                this.total = 0;
                localStorage.removeItem(CART_STORAGE_KEY);
                this.updateUI();
            },
            
            updateUI: function() {
                // Actualizar contador
                const totalItems = this.items.reduce((sum, item) => sum + item.quantity, 0);
                const counter = document.getElementById('cartCounter');
                
                if (totalItems > 0) {
                    counter.textContent = totalItems;
                    counter.style.display = 'flex';
                } else {
                    counter.style.display = 'none';
                }
                
                // Actualizar dropdown del carrito
                const cartItemsContainer = document.getElementById('cartItems');
                const cartTotalElement = document.getElementById('cartTotal');
                
                cartItemsContainer.innerHTML = '';
                
                if (this.items.length === 0) {
                    cartItemsContainer.innerHTML = '<p>Tu carrito está vacío</p>';
                    cartTotalElement.textContent = '0';
                    return;
                }
                
                this.items.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item';
                    itemElement.innerHTML = `
                        <img src="${item.image}" alt="${item.name}">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p>Talla: ${item.size} | Cantidad: ${item.quantity}</p>
                            <p>$${(item.price * item.quantity).toFixed(2)}</p>
                            <button class="remove-item" data-index="${index}">Eliminar</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });
                
                cartTotalElement.textContent = this.total.toFixed(2);
                
                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        this.removeItem(index);
                        showToast('Producto eliminado del carrito');
                    });
                });
            }
        };

        // Función para mostrar notificaciones
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Función para procesar la orden
        async function processOrder() {
            const user = auth.currentUser;
            
            if (!user) {
                showToast('Por favor inicia sesión para continuar', 'error');
                document.getElementById('loginModal').style.display = 'block';
                return null;
            }
            
            try {
                const batch = db.batch();
                const ordersCollection = db.collection('orders');
                const orderIds = [];
                
                // Crear un documento por cada item en el carrito
                cart.items.forEach(item => {
                    const orderRef = ordersCollection.doc();
                    orderIds.push(orderRef.id);
                    
                    batch.set(orderRef, {
                        userId: user.uid,
                        userEmail: user.email,
                        productId: item.id,
                        productName: item.name,
                        size: item.size,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.price * item.quantity,
                        status: 'completed',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        ip: await getClientIP()
                    });
                });
                
                // Ejecutar la transacción
                await batch.commit();
                return orderIds;
                
            } catch (error) {
                console.error("Error procesando orden:", error);
                throw error;
            }
        }

        // Función para obtener la IP del cliente
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }

        // Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar carrito
            cart.init();
            
            // Configurar el icono del carrito
            const cartIcon = document.getElementById('cartIcon');
            const cartDropdown = document.getElementById('cartDropdown');
            
            cartIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                cartDropdown.style.display = cartDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            document.addEventListener('click', () => {
                cartDropdown.style.display = 'none';
            });
            
            // Botón de añadir al carrito
            document.getElementById('addToCartBtn').addEventListener('click', () => {
                const product = {
                    id: 'hoodie-rider', // ID único del producto
                    name: document.querySelector('.product-title').textContent,
                    price: parseFloat(document.querySelector('.product-price').textContent.replace('$', '')),
                    size: document.querySelector('.size-option.selected').textContent,
                    quantity: 1,
                    image: document.querySelector('.product-image').src
                };
                
                cart.addItem(product);
                showToast('Producto añadido al carrito');
            });
            
            // Botón de comprar ahora (añade al carrito y va directo al checkout)
            document.getElementById('buyNowBtn').addEventListener('click', () => {
                const product = {
                    id: 'hoodie-rider',
                    name: document.querySelector('.product-title').textContent,
                    price: parseFloat(document.querySelector('.product-price').textContent.replace('$', '')),
                    size: document.querySelector('.size-option.selected').textContent,
                    quantity: 1,
                    image: document.querySelector('.product-image').src
                };
                
                cart.clear();
                cart.addItem(product);
                document.getElementById('checkoutModal').style.display = 'flex';
                updateCheckoutSummary();
            });
            
            // Botón de finalizar compra
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                if (cart.items.length === 0) {
                    showToast('El carrito está vacío', 'error');
                    return;
                }
                
                document.getElementById('checkoutModal').style.display = 'flex';
                updateCheckoutSummary();
            });
            
            // Botón de confirmar compra
            document.getElementById('confirmCheckout').addEventListener('click', async () => {
                try {
                    const orderIds = await processOrder();
                    
                    if (orderIds) {
                        // Mostrar confirmación
                        document.getElementById('checkoutModal').style.display = 'none';
                        
                        // Actualizar el modal de confirmación de orden
                        document.getElementById('confirmedSize').textContent = 
                            cart.items.map(item => `${item.size} (x${item.quantity})`).join(', ');
                        document.getElementById('orderId').textContent = orderIds.join(', ');
                        document.getElementById('orderConfirmation').style.display = 'flex';
                        
                        // Vaciar el carrito
                        cart.clear();
                    }
                } catch (error) {
                    showToast('Error al procesar la compra: ' + error.message, 'error');
                }
            });
            
            // Función para actualizar el resumen de compra
            function updateCheckoutSummary() {
                const summaryElement = document.getElementById('checkoutSummary');
                summaryElement.innerHTML = '';
                
                if (cart.items.length === 0) {
                    summaryElement.innerHTML = '<p>No hay productos en el carrito</p>';
                    return;
                }
                
                const list = document.createElement('ul');
                list.style.listStyle = 'none';
                list.style.marginBottom = '20px';
                
                cart.items.forEach(item => {
                    const li = document.createElement('li');
                    li.style.marginBottom = '10px';
                    li.style.paddingBottom = '10px';
                    li.style.borderBottom = '1px solid #333';
                    li.innerHTML = `
                        <strong>${item.name}</strong> - Talla: ${item.size}
                        <br>Cantidad: ${item.quantity} x $${item.price.toFixed(2)} = $${(item.price * item.quantity).toFixed(2)}
                    `;
                    list.appendChild(li);
                });
                
                const totalElement = document.createElement('div');
                totalElement.style.fontWeight = 'bold';
                totalElement.style.marginTop = '15px';
                totalElement.style.textAlign = 'right';
                totalElement.textContent = `Total: $${cart.total.toFixed(2)}`;
                
                summaryElement.appendChild(list);
                summaryElement.appendChild(totalElement);
            }
            
            // El resto de tu código existente (tabs, modals, etc.) se mantiene igual
            // ... (todo el código que ya tenías para tabs, image switching, etc.)
        });
    </script>
</body>
</html>
